<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Transaction Management</title>
<style>
  body { font-family: Arial; margin: 20px; }
  table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
  th { background: #f4f4f4; }
  .status-pending { color: orange; font-weight: bold; }
  .status-settled { color: green; font-weight: bold; }
  .status-failed { color: red; font-weight: bold; }
  .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
  .modal-content { background: white; padding: 20px; border-radius: 8px; width: 400px; }
  .modal-header { font-size: 18px; margin-bottom: 10px; }
  .close { float: right; cursor: pointer; font-weight: bold; }
  button { margin-top: 10px; padding: 8px 12px; cursor: pointer; }
  #formError { color: red; margin-bottom: 10px; display: none; }
</style>
</head>
<body>

<h1>Transaction Management</h1>

<table id="transactionsTable">
  <thead>
    <tr>
      <th>Date</th>
      <th>Account Number</th>
      <th>Account Holder</th>
      <th>Amount</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<button id="openModal">Add Transaction</button>

<!-- Modal -->
<div id="transactionModal" class="modal">
  <div class="modal-content">
    <span class="close" id="closeModal">&times;</span>
    <div class="modal-header">Add New Transaction</div>
    <div id="formError"></div>
    <form id="transactionForm">
      <input type="date" name="date" required><br><br>
      <input type="text" id="accountNumber" name="account_number" placeholder="Account Number (12 digits)" required maxlength="14"><br><br>
      <input type="text" name="account_holder" placeholder="Account Holder" required><br><br>
      <input type="number" id="amount" name="amount" placeholder="Amount" required step="0.01"><br><br>
      <button type="submit">Save</button>
    </form>
  </div>
</div>

<script>
const modal = document.getElementById("transactionModal");
const openModal = document.getElementById("openModal");
const closeModal = document.getElementById("closeModal");
const form = document.getElementById("transactionForm");
const tableBody = document.querySelector("#transactionsTable tbody");
const formError = document.getElementById("formError");

// Open/close modal
openModal.onclick = () => modal.style.display = "flex";
closeModal.onclick = () => { modal.style.display = "none"; form.reset(); formError.style.display = "none"; };

// Format account number
document.getElementById("accountNumber").addEventListener("input", e => {
  let value = e.target.value.replace(/\D/g, "").substring(0,12);
  e.target.value = value ? (value.match(/.{1,4}/g)?.join("-") || "") : "";
});

// Load transactions
async function loadTransactions() {
  try {
    const res = await fetch("/transactions"); // relative path for Rails
    if (!res.ok) throw new Error("Failed to fetch transactions");
    const transactions = await res.json();
    tableBody.innerHTML = "";
    transactions.forEach(tx => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${tx.date}</td>
        <td>${tx.account_number.replace(/(\d{4})(\d{4})(\d{4})/, "$1-$2-$3")}</td>
        <td>${tx.account_holder}</td>
        <td>${parseFloat(tx.amount).toFixed(2)}</td>
        <td class="status-${tx.status.toLowerCase()}">${tx.status}</td>
      `;
      tableBody.appendChild(row);
    });
  } catch (err) {
    console.error(err);
    tableBody.innerHTML = "<tr><td colspan='5'>Failed to load transactions</td></tr>";
  }
}

// Submit transaction
form.onsubmit = async e => {
  e.preventDefault();
  const formData = new FormData(form);

  // Validate account number
  let cleanAcc = formData.get("account_number").replace(/-/g, "");
  if (cleanAcc.length !== 12) {
    formError.textContent = "Account Number must be exactly 12 digits.";
    formError.style.display = "block";
    return;
  }
  formData.set("account_number", cleanAcc);

  // Validate amount
  let amount = parseFloat(formData.get("amount"));
  if (isNaN(amount) || amount <= 0) {
    formError.textContent = "Amount must be greater than 0.";
    formError.style.display = "block";
    return;
  }

  const newTransaction = Object.fromEntries(formData.entries());

  try {
    const res = await fetch("/transactions", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(newTransaction)
    });
    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.error || "Failed to save transaction");
    }

    // Success
    form.reset();
    formError.style.display = "none";
    modal.style.display = "none";
    loadTransactions();
  } catch (err) {
    formError.textContent = err.message;
    formError.style.display = "block";
  }
};

loadTransactions();
</script>
</body>
</html>
